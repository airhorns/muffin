<!DOCTYPE html>  <html> <head>   <title>muffin.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               muffin.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <h2>muffin.js: handy helpers for building cakefiles</h2>

<p>Licensed under the MIT License, excluding cloc.pl
Includes cloc.pl from http://cloc.sourceforge.net/, licensed under GPL V2</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">CoffeeScript     = </span><span class="nx">require</span> <span class="s1">&#39;coffee-script&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Require Q for all the handy promise based business</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">q                = </span><span class="nx">require</span> <span class="s1">&#39;q&#39;</span>
<span class="nv">fs               = </span><span class="nx">require</span> <span class="s1">&#39;q-fs&#39;</span>
<span class="nv">ofs              = </span><span class="nx">require</span> <span class="s1">&#39;fs&#39;</span>
<span class="nv">path             = </span><span class="nx">require</span> <span class="s1">&#39;path&#39;</span>
<span class="nv">glob             = </span><span class="nx">require</span> <span class="s1">&#39;glob&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Require <code>child_process</code> and grab a reference to it so the identifier <code>exec</code> is free.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">{</span><span class="nx">spawn</span><span class="p">,</span> <span class="nx">exec</span><span class="p">}</span>    <span class="o">=</span> <span class="nx">require</span> <span class="s1">&#39;child_process&#39;</span>
<span class="nv">orgExec = </span><span class="nx">exec</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Simple variadic extend</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">extend = </span><span class="nf">(onto, others...) -&gt;</span>
  <span class="nv">result = </span><span class="nx">onto</span>
  <span class="k">for</span> <span class="nx">o</span> <span class="k">in</span> <span class="nx">others</span>
    <span class="k">for</span> <span class="nx">k</span><span class="p">,</span><span class="nx">v</span> <span class="k">of</span> <span class="nx">o</span>
      <span class="nx">result</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">v</span>
  <span class="nx">result</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Promise based version of <code>exec</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">exec = </span><span class="nf">(command, options = {}) -&gt;</span>
  <span class="nv">deferred = </span><span class="nx">q</span><span class="p">.</span><span class="nx">defer</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Wrap the execution of the original <code>exec</code> function in a deferred.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">child = </span><span class="nx">orgExec</span><span class="p">(</span><span class="nx">command</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nf">(error, stdout, stderr) -&gt;</span>
    <span class="k">if</span> <span class="nx">error</span><span class="o">?</span>
      <span class="nx">deferred</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span><span class="p">([</span><span class="nx">stdout</span><span class="p">,</span> <span class="nx">stderr</span><span class="p">])</span>
  <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Return both the child process (for writing to stdin) and the promise.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="p">[</span><span class="nx">child</span><span class="p">,</span> <span class="nx">deferred</span><span class="p">.</span><span class="nx">promise</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Internal helper function for deciding if the repo is in the midst of a rebase.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">inRebase = </span><span class="o">-&gt;</span>
  <span class="nx">path</span><span class="p">.</span><span class="nx">existsSync</span><span class="p">(</span><span class="s1">&#39;.git/rebase-apply&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Notifies the user of a success or error during compilation</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">notify = </span><span class="nf">(source, origMessage, error = false) -&gt;</span>
  <span class="k">if</span> <span class="nx">error</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>If notifying about an error, make sure any errors actually reference the file being
compiled.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">basename = </span><span class="nx">source</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^.*[\/\\]/</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nv">m = </span><span class="nx">origMessage</span><span class="p">.</span><span class="nx">match</span> <span class="sr">/Parse error on line (\d+)/</span>
      <span class="nv">message = </span><span class="s2">&quot;Parse error in #{basename}\non line #{m[1]}.&quot;</span>
    <span class="k">else</span>
      <span class="nv">message = </span><span class="s2">&quot;Error in #{basename}.&quot;</span>
    <span class="nv">command = </span><span class="nx">growlCommand</span> <span class="s1">&#39;-n&#39;</span><span class="p">,</span> <span class="s1">&#39;Cake&#39;</span><span class="p">,</span> <span class="s1">&#39;-p&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;-t&#39;</span><span class="p">,</span> <span class="s2">&quot;\&quot;Action failed\&quot;&quot;</span><span class="p">,</span> <span class="s1">&#39;-m&#39;</span><span class="p">,</span> <span class="s2">&quot;\&quot;#{message}\&quot;&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Always log any autogenerated messages as well as the error message to the console</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span> <span class="nx">message</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span> <span class="nx">origMessage</span>
  <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Growl the successful action (usually a compilation) to the user, and always log it to the console as well.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">command = </span><span class="nx">growlCommand</span> <span class="s1">&#39;-n&#39;</span><span class="p">,</span> <span class="s1">&#39;Cake&#39;</span><span class="p">,</span> <span class="s1">&#39;-p&#39;</span><span class="p">,</span> <span class="s1">&#39;-1&#39;</span><span class="p">,</span> <span class="s1">&#39;-t&#39;</span><span class="p">,</span> <span class="s2">&quot;\&quot;Action Succeeded\&quot;&quot;</span><span class="p">,</span> <span class="s1">&#39;-m&#39;</span><span class="p">,</span> <span class="s2">&quot;\&quot;#{source}\&quot;&quot;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">origMessage</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Growl if we can, or</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="nx">growlAvailble</span>
    <span class="p">[</span><span class="nx">child</span><span class="p">,</span> <span class="nx">promise</span><span class="p">]</span> <span class="o">=</span> <span class="nx">exec</span> <span class="nx">command</span>
  <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>return an already fufilled promise if not</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">promise = </span><span class="nx">q</span><span class="p">.</span><span class="nx">ref</span> <span class="kc">true</span>
  <span class="nx">promise</span>

<span class="nv">readFile = </span><span class="nf">(file, options = {}) -&gt;</span>
  <span class="nv">deferred = </span><span class="nx">q</span><span class="p">.</span><span class="nx">defer</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Read the file from the git index if we're using the stage as the files being caked,
or otherwise use <code>q-fs</code> to read the file and return a promise.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="nx">runOptions</span><span class="p">.</span><span class="nx">commit</span>
    <span class="p">[</span><span class="nx">child</span><span class="p">,</span> <span class="nx">promise</span><span class="p">]</span> <span class="o">=</span> <span class="nx">exec</span> <span class="s2">&quot;git show :#{file}&quot;</span>
    <span class="nx">child</span><span class="p">.</span><span class="nx">stdin</span><span class="p">.</span><span class="nx">setEncoding</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>
    <span class="nx">child</span><span class="p">.</span><span class="nx">stdin</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span>
    <span class="nx">q</span><span class="p">.</span><span class="k">when</span> <span class="nx">promise</span>
    <span class="p">,</span> <span class="nf">(stdout, stderr) -&gt;</span>
      <span class="nv">lines = </span><span class="nx">stdout</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">)</span>
      <span class="nx">lines</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span>
      <span class="nv">str = </span><span class="nx">lines</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">)</span>
      <span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span>
    <span class="p">,</span> <span class="nf">(reason) -&gt;</span>
      <span class="nx">handleFileError</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">reason</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>
  <span class="k">else</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">read</span><span class="p">(</span><span class="nx">file</span><span class="p">).</span><span class="k">then</span><span class="p">(</span><span class="nf">(contents) -&gt;</span>
      <span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">contents</span><span class="p">)</span>
    <span class="p">,</span> <span class="nf">(reason) -&gt;</span>
      <span class="nx">handleFileError</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">reason</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>
    <span class="p">)</span>

  <span class="nx">deferred</span><span class="p">.</span><span class="nx">promise</span>

<span class="nv">writeFile = </span><span class="nf">(file, data, options = {}) -&gt;</span>
  <span class="nv">mode = </span><span class="nx">options</span><span class="p">.</span><span class="nx">mode</span> <span class="o">||</span> <span class="mi">644</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Write the file to the git index if we're using the stage as the files being caked,
or otherwise use <code>q-fs</code> to write while returning a promise.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="nx">runOptions</span><span class="p">.</span><span class="nx">commit</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>With git, it takes two stages to stage a file. We write the object to <code>git hash-object</code> over
stdin and wait for it to spit a sha back out. We then update the index with the new hashed
file using the sha as a reference and in the mode passed in.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">[</span><span class="nx">child</span><span class="p">,</span> <span class="nx">promise</span><span class="p">]</span> <span class="o">=</span> <span class="nx">exec</span> <span class="s2">&quot;git hash-object --stdin -w&quot;</span>
    <span class="nx">child</span><span class="p">.</span><span class="nx">stdin</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
    <span class="nx">child</span><span class="p">.</span><span class="nx">stdin</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span>

    <span class="nx">promise</span><span class="p">.</span><span class="k">then</span> <span class="nf">([stdout, stderr]) -&gt;</span>
      <span class="nv">sha = </span><span class="nx">stdout</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">40</span><span class="p">)</span>
      <span class="p">[</span><span class="nx">subchild</span><span class="p">,</span> <span class="nx">subpromise</span><span class="p">]</span> <span class="o">=</span> <span class="nx">exec</span> <span class="s2">&quot;git update-index --add --cacheinfo 100#{mode.toString(8)} #{sha} #{file}&quot;</span>
      <span class="k">return</span> <span class="nx">subpromise</span>

    <span class="k">return</span> <span class="nx">promise</span>
  <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Write the file, and then chmod the file using <code>q</code> promises.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">fs</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="s2">&quot;UTF-8&quot;</span><span class="p">).</span><span class="k">then</span> <span class="nf">(data) -&gt;</span>
      <span class="k">return</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">chmod</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">mode</span>
    <span class="p">,</span> <span class="nf">(reason) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Make the common permissions error look a bit nicer.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">reason</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">match</span><span class="p">(</span><span class="sr">/not writable/g</span><span class="p">)</span>
        <span class="nx">q</span><span class="p">.</span><span class="nx">reject</span> <span class="s2">&quot;#{file} isn&#39;t writable, please check permissions!&quot;</span>
      <span class="k">else</span>
        <span class="nx">q</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="nx">reason</span><span class="p">)</span>

<span class="nv">copyFile = </span><span class="nf">(source, target, options = {}) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Read the file at the source and then write the file at the target</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">readFile</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="nx">options</span><span class="p">).</span><span class="k">then</span> <span class="nf">(contents) -&gt;</span>
    <span class="nx">writeFile</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">contents</span><span class="p">,</span> <span class="nx">options</span><span class="p">).</span><span class="k">then</span> <span class="o">-&gt;</span>
      <span class="nx">notify</span> <span class="nx">source</span><span class="p">,</span> <span class="s2">&quot;Moved #{source} to #{target} successfully&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Handy promise based file error handler, which is a simple wrapper for <code>notify</code></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">handleFileError = </span><span class="nf">(file, err, options = {}) -&gt;</span>
  <span class="nx">notify</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span> <span class="kc">true</span> <span class="nx">unless</span> <span class="nx">options</span><span class="p">.</span><span class="nx">notify</span> <span class="o">==</span> <span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Following 2 functions are stolen from Jitter, https://github.com/TrevorBurnham/Jitter/blob/master/src/jitter.coffee
Compiles a script to a destination</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">compileScript = </span><span class="nf">(source, target, options = {}) -&gt;</span>
  <span class="nx">readFile</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="nx">options</span><span class="p">).</span><span class="k">then</span> <span class="nf">(data) -&gt;</span>
    <span class="k">try</span>
      <span class="nv">js = </span><span class="nx">CoffeeScript</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">data</span><span class="p">,</span> <span class="p">{</span><span class="nx">source</span><span class="p">,</span> <span class="nv">bare: </span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">bare</span><span class="p">}</span>
      <span class="nx">writeFile</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">js</span><span class="p">,</span> <span class="nx">options</span><span class="p">).</span><span class="k">then</span> <span class="o">-&gt;</span>
        <span class="nx">notify</span> <span class="nx">source</span><span class="p">,</span> <span class="s2">&quot;Compiled #{source} to #{target} successfully&quot;</span> <span class="nx">unless</span> <span class="nx">options</span><span class="p">.</span><span class="nx">notify</span> <span class="o">==</span> <span class="kc">false</span>
    <span class="k">catch</span> <span class="nx">err</span>
      <span class="nx">handleFileError</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">options</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Generate a command to growl</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">growlCommand = </span><span class="nf">(args...) -&gt;</span>
  <span class="nx">args</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="s1">&#39;growlnotify&#39;</span><span class="p">)</span>
  <span class="nx">args</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Check if growl is available so we can growl notifications only if growl is present</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">growlAvailble = </span><span class="kc">false</span>
<span class="nx">orgExec</span> <span class="nx">growlCommand</span><span class="p">(</span><span class="s1">&#39;--version&#39;</span><span class="p">),</span> <span class="nf">(err, stdout, stderr) -&gt;</span>
  <span class="nv">growlAvailble = </span><span class="nx">err</span><span class="o">?</span>

<span class="nv">doccoFile = </span><span class="nf">(source, options = {}) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Just tell docco to generate the one file by using it's command line helper</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="p">[</span><span class="nx">child</span><span class="p">,</span> <span class="nx">promise</span><span class="p">]</span> <span class="o">=</span> <span class="nx">exec</span><span class="p">(</span><span class="s2">&quot;docco #{source}&quot;</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">promise</span><span class="p">.</span><span class="k">then</span> <span class="nf">([stdout, stderr]) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Notify the user if any errors occured.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">notify</span> <span class="nx">source</span><span class="p">,</span> <span class="nx">stdout</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="k">if</span> <span class="nx">stdout</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="nx">notify</span> <span class="nx">source</span><span class="p">,</span> <span class="nx">stderr</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span> <span class="kc">true</span> <span class="k">if</span> <span class="nx">stderr</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>

<span class="nv">minifyScript = </span><span class="nf">(source, options = {}) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Grab a reference to uglify. This isn't always globablly required since not everyone will minimize.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="p">{</span><span class="nx">parser</span><span class="p">,</span> <span class="nx">uglify</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;uglify-js&quot;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Read the file and then step through the transformations of the AST.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">readFile</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="nx">options</span><span class="p">).</span><span class="k">then</span> <span class="nf">(original) -&gt;</span>
    <span class="nv">ast = </span><span class="nx">parser</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">original</span><span class="p">)</span>  <span class="c1"># Parse original JS code and get the initial AST.</span>
    <span class="nv">ast = </span><span class="nx">uglify</span><span class="p">.</span><span class="nx">ast_mangle</span><span class="p">(</span><span class="nx">ast</span><span class="p">)</span>  <span class="c1"># Get a new AST with mangled names.</span>
    <span class="nv">ast = </span><span class="nx">uglify</span><span class="p">.</span><span class="nx">ast_squeeze</span><span class="p">(</span><span class="nx">ast</span><span class="p">)</span> <span class="c1"># Get an AST with compression optimizations.</span>
    <span class="nv">final = </span><span class="nx">uglify</span><span class="p">.</span><span class="nx">gen_code</span><span class="p">(</span><span class="nx">ast</span><span class="p">)</span>
    <span class="nv">finalPath = </span><span class="nx">source</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
    <span class="nx">finalPath</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span>
    <span class="nx">finalPath</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;min.js&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Write out the final code to the same file with a <code>min.js</code> extension instead of just <code>.js</code>. This
is also returned as a promise for chaining if need be.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="nx">writeFile</span><span class="p">(</span><span class="nx">finalPath</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">),</span> <span class="nx">final</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Internal tracking variable and function used for asserting that Perl exists on the system muffin is being run on.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">perlPresent = </span><span class="kc">undefined</span>
<span class="nv">perlError = </span><span class="nf">() -&gt;</span> <span class="k">throw</span> <span class="s1">&#39;You need a perl v5.3 or higher installed to do this with muffin.&#39;</span>
<span class="nv">ensurePerl = </span><span class="nf">() -&gt;</span>
  <span class="k">if</span> <span class="nx">perlPresent</span><span class="o">?</span>
    <span class="nx">perlError</span><span class="p">()</span> <span class="nx">unless</span> <span class="nx">perlPresent</span>
  <span class="k">else</span>
    <span class="nx">orgExec</span> <span class="s1">&#39;perl --version&#39;</span><span class="p">,</span> <span class="nf">(error, stdout, stderr) -&gt;</span>
      <span class="k">if</span> <span class="nx">error</span><span class="o">?</span>
        <span class="nv">perlPresent = </span><span class="kc">false</span>
        <span class="nx">perlError</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Grab absolute references to the cloc file and language definition (an extension of the default one but including Coffeescript)</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">clocPath = </span><span class="nx">path</span><span class="p">.</span><span class="nx">normalize</span><span class="p">(</span> <span class="nx">__dirname</span> <span class="o">+</span> <span class="s2">&quot;/../deps/cloc.pl&quot;</span> <span class="p">)</span>
<span class="nv">langDefPath = </span><span class="nx">path</span><span class="p">.</span><span class="nx">normalize</span><span class="p">(</span> <span class="nx">__dirname</span> <span class="o">+</span> <span class="s2">&quot;/../deps/cloc_lang_def.txt&quot;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Use <code>cloc</code> in the deps dir to count the SLOC in the file.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">clocFile = </span><span class="nf">(filename) -&gt;</span>
  <span class="nx">ensurePerl</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Grab the output of <code>cloc</code> in CSV.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="p">[</span><span class="nx">child</span><span class="p">,</span> <span class="nx">promise</span><span class="p">]</span> <span class="o">=</span> <span class="nx">exec</span> <span class="s2">&quot;#{clocPath} --csv --read-lang-def=#{langDefPath} #{filename}&quot;</span>

  <span class="nx">q</span><span class="p">.</span><span class="k">when</span> <span class="nx">promise</span><span class="p">,</span> <span class="nf">([csv, stderr]) -&gt;</span>
    <span class="k">throw</span> <span class="nx">stderr</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="k">if</span> <span class="nx">stderr</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Split up the output into headers and CSV by splitting by double newline, and then into rows
by splitting by newline.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">[</span><span class="nx">discard</span><span class="p">,</span> <span class="nx">csv</span><span class="p">]</span> <span class="o">=</span> <span class="nx">csv</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;\n\n&quot;</span><span class="p">)</span>
    <span class="nv">rows = </span><span class="nx">csv</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>Discard the row of column names, discard the empty newline at the end, and then split each row
into comma delimited columns.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">names = </span><span class="nx">rows</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span>
    <span class="nx">rows</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span>
    <span class="nv">rows = </span><span class="nx">rows</span><span class="p">.</span><span class="nx">map</span> <span class="nf">(row) -&gt;</span> <span class="nx">row</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>Use the first row since we've only passed one file to <code>cloc</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">row = </span><span class="nx">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="p">{</span>
      <span class="nv">filename: </span><span class="nx">filename</span>
      <span class="nv">filetype: </span><span class="nx">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
      <span class="nv">blank: </span><span class="nx">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
      <span class="nv">comment: </span><span class="nx">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
      <span class="nv">sloc: </span><span class="nx">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>Use <code>fs.stat</code> to grab the filesize and modified time of a file.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">statFile = </span><span class="nf">(filename) -&gt;</span>
  <span class="nx">q</span><span class="p">.</span><span class="k">when</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">stat</span><span class="p">(</span><span class="nx">filename</span><span class="p">),</span> <span class="nf">(stats) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>Convert the filesize (which comes in in bytes) into a more human readable form by
dividing by 1024 for each unit.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">size = </span><span class="nx">stats</span><span class="p">.</span><span class="nx">size</span>
    <span class="nv">units = </span><span class="p">[</span><span class="s2">&quot;bytes&quot;</span><span class="p">,</span> <span class="s2">&quot;KB&quot;</span><span class="p">,</span> <span class="s2">&quot;MB&quot;</span><span class="p">,</span> <span class="s2">&quot;GB&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="nx">unit</span> <span class="k">in</span> <span class="nx">units</span>
      <span class="k">break</span> <span class="k">if</span> <span class="nx">size</span> <span class="o">&lt;</span> <span class="mi">1024</span>
      <span class="nv">size = </span><span class="nx">size</span> <span class="err">/ 1024</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>Round off the final value to two digits and set the size to a human readable string.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">size = </span><span class="s2">&quot;#{(Math.round(size*100)/100).toFixed(2)} #{unit}&quot;</span>

    <span class="k">return</span> <span class="p">{</span>
      <span class="nv">size: </span><span class="nx">size</span>
      <span class="nv">modified: </span><span class="nx">stats</span><span class="p">.</span><span class="nx">mtime</span>
      <span class="nv">filename: </span><span class="nx">filename</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>Logs a stats about files to the console for inspection.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">statFiles = </span><span class="nf">(files, options = {}) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>Grab the array of fields to include in the output.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">fields = </span><span class="nx">options</span><span class="p">.</span><span class="nx">fields</span> <span class="o">||</span> <span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">,</span> <span class="s1">&#39;filetype&#39;</span><span class="p">,</span> <span class="s1">&#39;sloc&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>If given a string, glob it to expand any wildcards.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="k">typeof</span> <span class="nx">files</span> <span class="o">is</span> <span class="s1">&#39;string&#39;</span>
    <span class="nv">files = </span><span class="nx">glob</span><span class="p">.</span><span class="nx">globSync</span> <span class="nx">files</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>For every file to be statted, <code>cloc</code> and <code>fs.stat</code> them both using the two respective helpers. These
both return promises which we join. For each file (and joined promise), ensure the promise resolves to
the merged stats objects from both helpers.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">promises = </span><span class="nx">files</span><span class="p">.</span><span class="nx">map</span> <span class="nf">(file) -&gt;</span>
    <span class="nx">q</span><span class="p">.</span><span class="nx">join</span> <span class="nx">clocFile</span><span class="p">(</span><span class="nx">file</span><span class="p">),</span> <span class="nx">statFile</span><span class="p">(</span><span class="nx">file</span><span class="p">),</span> <span class="nf">(clocstats, filestats) -&gt;</span>
      <span class="nx">extend</span> <span class="nx">clocstats</span><span class="p">,</span> <span class="nx">filestats</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>Ensure any errors thrown during the join of the statting aren't swallowed by marking the promises as no longer
chainable.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">promise</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span> <span class="k">for</span> <span class="nx">promise</span> <span class="k">in</span> <span class="nx">promises</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>For every file's stats (or promise thereof), print out the row in the table. Do this by first figuring out
what the widest value in each column is, and then printing while padding all the shorter values out until they
reach the same length.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">x = </span><span class="nx">q</span><span class="p">.</span><span class="nx">join</span> <span class="nx">promises</span><span class="p">...,</span> <span class="nf">(results...) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>Add the headers to the top of the table.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">headers = </span><span class="p">{}</span>
    <span class="k">for</span> <span class="nx">field</span> <span class="k">in</span> <span class="nx">fields</span>
      <span class="nx">headers</span><span class="p">[</span><span class="nx">field</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">field</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">toUpperCase</span><span class="p">()</span> <span class="o">+</span> <span class="nx">field</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="nx">results</span><span class="p">.</span><span class="nx">unshift</span> <span class="nx">headers</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>Figure out how wide each column must be, keyed by integer column index. Note that the header row is included
in the fields array here because a header may be the widest cell in the column.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">maxLengths = </span><span class="k">for</span> <span class="nx">field</span> <span class="k">in</span> <span class="nx">fields</span>
      <span class="nv">max = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">.</span><span class="nx">apply</span> <span class="nb">Math</span><span class="p">,</span> <span class="nx">results</span><span class="p">.</span><span class="nx">map</span> <span class="nf">(result) -&gt;</span> <span class="nx">result</span><span class="p">[</span><span class="nx">field</span><span class="p">].</span><span class="nx">toString</span><span class="p">().</span><span class="nx">length</span>
      <span class="nx">max</span> <span class="o">+</span> <span class="mi">2</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>Print out each row of results. Use a mutable array buffer which is then joined so new strings aren't created with a
bunch of += ops.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span> <span class="nx">result</span> <span class="k">in</span> <span class="nx">results</span>
      <span class="nv">out = </span><span class="p">[]</span>
      <span class="k">for</span> <span class="nx">field</span><span class="p">,</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">fields</span>
        <span class="nv">data = </span><span class="nx">result</span><span class="p">[</span><span class="nx">field</span><span class="p">].</span><span class="nx">toString</span><span class="p">()</span>
        <span class="nx">out</span><span class="p">.</span><span class="nx">push</span> <span class="s1">&#39; &#39;</span> <span class="k">for</span> <span class="nx">j</span> <span class="k">in</span> <span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">..</span><span class="nx">maxLengths</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span>
        <span class="nx">out</span><span class="p">.</span><span class="nx">push</span> <span class="nx">data</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">out</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="nx">results</span>
  <span class="nx">x</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p><code>compileMap</code> is an internal helper for taking the passed in options to <code>muffin.run</code> and turning strings
into useful objects.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">compileMap = </span><span class="nf">(map) -&gt;</span>
  <span class="k">for</span> <span class="nx">pattern</span><span class="p">,</span> <span class="nx">action</span> <span class="k">of</span> <span class="nx">map</span>
    <span class="p">{</span><span class="nv">pattern: </span><span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="nx">pattern</span><span class="p">),</span> <span class="nv">action: </span><span class="nx">action</span><span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>Store a reference to the options that muffin was run with so we can ensure that none get lost if they don't get passed in by the user.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">runOptions = </span><span class="p">{}</span>

<span class="nv">run = </span><span class="nf">(args) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>Grab the glob if not given by globbing a default string, globbing a given string, or globbing the array of given strings.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="o">!</span><span class="nx">args</span><span class="p">.</span><span class="nx">files</span><span class="o">?</span>
    <span class="nv">args.files = </span><span class="nx">glob</span><span class="p">.</span><span class="nx">globSync</span> <span class="s1">&#39;./**/*&#39;</span>
  <span class="k">else</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">args</span><span class="p">.</span><span class="nx">files</span> <span class="o">is</span> <span class="s1">&#39;string&#39;</span>
    <span class="nv">args.files = </span><span class="nx">glob</span><span class="p">.</span><span class="nx">globSync</span> <span class="nx">args</span><span class="p">.</span><span class="nx">files</span>
  <span class="k">else</span>
    <span class="nv">args.files = </span><span class="nx">args</span><span class="p">.</span><span class="nx">files</span><span class="p">.</span><span class="nx">map</span> <span class="nf">(x) -&gt;</span> <span class="nx">glob</span><span class="p">.</span><span class="nx">globSync</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span>

  <span class="nv">compiledMap = </span><span class="nx">compileMap</span> <span class="nx">args</span><span class="p">.</span><span class="nx">map</span>
  </pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>Save the reference to this run's options. Unfortuantly this renders muffin not many run safe. Bummer, for now.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">runOptions = </span><span class="nx">args</span><span class="p">.</span><span class="nx">options</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>Run the before callback, and wait till it finishes by wrapping it in a <code>q.ref</code> call to get a promise.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">before = </span><span class="o">-&gt;</span> <span class="nx">q</span><span class="p">.</span><span class="nx">ref</span> <span class="k">if</span> <span class="nx">args</span><span class="p">.</span><span class="nx">before</span> <span class="k">then</span> <span class="nx">args</span><span class="p">.</span><span class="nx">before</span><span class="p">()</span> <span class="k">else</span> <span class="kc">true</span>
  <span class="nx">q</span><span class="p">.</span><span class="k">when</span> <span class="nv">start = </span><span class="nx">before</span><span class="p">(),</span></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>Once the before callback has been successfully run, loop over all the pattern -> action pairs, and see if they
match any of the files in the array. If so, delete the file, and run the action.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">done = </span><span class="nx">compiledMap</span><span class="p">.</span><span class="nx">reduce</span> <span class="nf">(done, map) -&gt;</span>
      <span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">file</span> <span class="k">of</span> <span class="nx">args</span><span class="p">.</span><span class="nx">files</span>
        <span class="k">if</span> <span class="nv">matches = </span><span class="nx">map</span><span class="p">.</span><span class="nx">pattern</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span>
          <span class="k">delete</span> <span class="nx">args</span><span class="p">.</span><span class="nx">files</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>Do the job and wrap it in a promise if it didn't already return one using <code>q.ref</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nv">work = </span><span class="nx">q</span><span class="p">.</span><span class="nx">ref</span> <span class="nx">map</span><span class="p">.</span><span class="nx">action</span><span class="p">(</span><span class="nx">matches</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>Watch the file if the option was given.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="k">if</span> <span class="nx">args</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">watch</span>
            <span class="k">if</span> <span class="nx">args</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">commit</span>
              <span class="nx">console</span><span class="p">.</span><span class="nx">error</span> <span class="s2">&quot;Can&#39;t watch committed versions of files, sorry!&quot;</span>
              <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span> <span class="mi">1</span>
            <span class="nx">do</span> <span class="nf">(map, matches) -&gt;</span>
              <span class="nx">ofs</span><span class="p">.</span><span class="nx">watchFile</span> <span class="nx">file</span><span class="p">,</span> <span class="nv">persistent: </span><span class="kc">true</span><span class="p">,</span> <span class="nv">interval: </span><span class="mi">250</span><span class="p">,</span> <span class="nf">(curr, prev) -&gt;</span>
                <span class="k">return</span> <span class="k">if</span> <span class="nx">curr</span><span class="p">.</span><span class="nx">mtime</span><span class="p">.</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">is</span> <span class="nx">prev</span><span class="p">.</span><span class="nx">mtime</span><span class="p">.</span><span class="nx">getTime</span><span class="p">()</span>
                <span class="k">return</span> <span class="k">if</span> <span class="nx">inRebase</span><span class="p">()</span>
                <span class="nx">q</span><span class="p">.</span><span class="k">when</span> <span class="nv">start = </span><span class="nx">before</span><span class="p">(),</span> <span class="o">-&gt;</span>
                  <span class="nv">work = </span><span class="nx">q</span><span class="p">.</span><span class="nx">ref</span> <span class="nx">map</span><span class="p">.</span><span class="nx">action</span><span class="p">(</span><span class="nx">matches</span><span class="p">)</span>
                  <span class="nx">q</span><span class="p">.</span><span class="k">when</span> <span class="nx">work</span><span class="p">,</span> <span class="nf">(result) -&gt;</span>
                    <span class="nx">args</span><span class="p">.</span><span class="nx">after</span><span class="p">()</span> <span class="k">if</span> <span class="nx">args</span><span class="p">.</span><span class="nx">after</span>
                  <span class="nx">work</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span>

                <span class="nx">start</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p>Return another promise which will resolve to the work promise</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nv">done = </span><span class="nx">q</span><span class="p">.</span><span class="k">when</span><span class="p">(</span><span class="nx">done</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="nx">work</span><span class="p">)</span>
      <span class="nx">done</span>
    <span class="p">,</span> <span class="kc">undefined</span>

    <span class="nx">q</span><span class="p">.</span><span class="k">when</span> <span class="nx">done</span><span class="p">,</span> <span class="nf">() -&gt;</span>
      <span class="nx">args</span><span class="p">.</span><span class="nx">after</span><span class="p">()</span> <span class="k">if</span> <span class="nx">args</span><span class="p">.</span><span class="nx">after</span>
    <span class="nx">done</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span>

  <span class="nx">start</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span>

<span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="p">{</span><span class="nx">run</span><span class="p">,</span> <span class="nx">copyFile</span><span class="p">,</span> <span class="nx">doccoFile</span><span class="p">,</span> <span class="nx">notify</span><span class="p">,</span> <span class="nx">minifyScript</span><span class="p">,</span> <span class="nx">readFile</span><span class="p">,</span> <span class="nx">writeFile</span><span class="p">,</span> <span class="nx">compileScript</span><span class="p">,</span> <span class="nx">exec</span><span class="p">,</span> <span class="nx">extend</span><span class="p">,</span> <span class="nx">statFiles</span><span class="p">}</span>
  <span class="nx">exports</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">v</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 